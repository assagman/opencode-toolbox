# Extensive unit test setup plan (≈66–74% → 95%)

## Goal
- Raise **overall line coverage to 95%** (lcov/Codecov) while keeping tests **fast, deterministic, and offline**.
- Keep CI reporting to Codecov; **defer gating** until coverage is ≥95%.

## Current State (Observed)
- **Runtime / test runner:** Bun (`bun:test`) (`package.json`).
- **Coverage generation:** `bun test --coverage` and CI uses `bun test --coverage --coverage-reporter=lcov` to produce `coverage/lcov.info`.
- **CI:** `.github/workflows/ci.yml` runs tests + uploads to Codecov, but **does not enforce a minimum**.
- **Coverage:** Codecov currently shows ~**66% line** (per user); `TESTING.md` reports **74.33% line** and **72.80% function** (needs baseline alignment).

## Repo Map (Coverage ROI via LOC)

### Source LOC (highest ROI first)

| File | LOC | Why it matters |
|---|---:|---|
| `src/plugin.ts` | 1088 | Biggest file; many branches/tools (likely main coverage sink) |
| `src/mcp-client/manager.ts` | 421 | Core orchestration; more edge cases (timeouts/partial init) |
| `src/search/bm25.ts` | 293 | Async indexing + incremental updates have branches |
| `src/profiler/profiler.ts` | 270 | Pure logic; easy coverage wins |
| `src/mcp-client/fake.ts` | 226 | Test utilities; already heavily exercised |
| `src/config/loader.ts` | 154 | Error paths + file handling |
| `src/mcp-client/remote.ts` | 136 | StreamableHTTP↔SSE fallback logic |
| `src/catalog/catalog.ts` | 105 | Normalization edge cases |
| `src/mcp-client/local.ts` | 76 | Stdio transport setup |

### Existing tests
- Unit: `test/unit/*.test.ts` (config/search/catalog/plugin/mcp-manager).
- Integration/E2E: `test/integration/*`, `test/e2e/*`.

## Strategy

### Principle
- Prefer **unit tests on pure logic** first (fastest, most stable), then **IO-heavy paths via mocks/DI**, and only then **integration/e2e** for confidence.

### Key constraint
- Some code paths are “real IO” (stdio spawn, HTTP/SSE). To hit 95% without flaky tests:
  - **Mock transports / SDK clients**, or
  - **introduce minimal dependency injection (DI)** in production code to make IO replaceable.

## Plan (Phased)

### Phase 0 — Baseline & coverage gap map
1. Run coverage locally:
   - `bun test --coverage`
   - `bun test --coverage --coverage-reporter=lcov`
2. Produce a **top-uncovered-files** list from `coverage/lcov.info` and/or Bun’s text summary.
3. Align with Codecov: **line coverage**, counting **all tests** (unit+integration+e2e), and confirm where the 66% delta comes from.

**Output artifact:**
- A table: `file → %lines/%funcs (or lines hit / total)` to drive ROI.

### Phase 1 — Easy high-signal coverage wins (pure logic)
1. Add unit tests for `src/profiler/profiler.ts` (percentiles, stats, timers, reset, export).
2. Expand `src/search/bm25.ts` tests to cover:
   - async indexing (`indexToolsAsync`, `addToolsAsync`),
   - incremental operations (`addTool`, `removeTool`, `has`, `getStats`).

**Acceptance criteria:**
- Profiler module is ~fully covered.
- BM25 module coverage significantly improves without slowing test suite.

### Phase 2 — Cover real MCP clients without real IO

#### 2A: `LocalMCPClient` (`src/mcp-client/local.ts`)
- Add tests for:
  - missing/empty command error,
  - env merge behavior,
  - `close()` idempotency,
  - tools caching behavior.

#### 2B: `RemoteMCPClient` (`src/mcp-client/remote.ts`)
- Add tests for:
  - missing URL error,
  - Streamable HTTP success,
  - Streamable HTTP failure → SSE fallback success,
  - both fail → throws,
  - `getTransportType()` behavior.

**Implementation approach (recommended):**
- Use **DI or module mocking** to replace `@modelcontextprotocol/sdk` `Client` + transports.

ASCII sketch:
```
RemoteMCPClient.connect()
  ├─ try StreamableHTTPClientTransport → connect OK → transportType=streamable-http
  └─ catch → close attempted transport → reset Client → try SSEClientTransport
         ├─ connect OK → transportType=sse
         └─ catch → close attempted transport → throw
```

### Phase 3 — `src/plugin.ts` (largest gap)

#### 3A: Expand tool coverage via tests
- Add/extend tests to cover **all tool handlers**:
  - `toolbox_perf` output structure (profiler export + index stats)
  - `toolbox_test` (loop, predefined prompts, generated args, pass/fail/timeout counters)
  - `toolbox_execute` success path + richer error path (serverInfo mapping)
  - system prompt hook: `experimental.chat.system.transform`

#### 3B: Introduce minimal DI to enable `toolbox_test` loop coverage
- `toolbox_test` needs a non-empty tool list without connecting to real servers.
- Recommended minimal change:
  - export a `createToolboxPlugin(deps)` factory in `src/plugin.ts` that allows injecting a fake `MCPManager` and (optionally) `fs/promises` for log/command-file writes.

Diagram:
```
createToolboxPlugin({ mcpManagerFactory, fs })
  └─ returns async (ctx) => { ... uses injected deps ... }

Tool tests
  └─ provide FakeMCPManager: getAllCatalogTools(), callTool(), getAllServers(), ...
```

**Acceptance criteria:**
- `src/plugin.ts` becomes the primary driver of coverage improvement.
- Tests remain offline and deterministic.

### Phase 4 — Coverage gating (deferred)
- Decision: **no gating yet**; keep CI uploading lcov to Codecov.
- Optional follow-up after reaching 95%: add `codecov.yml` and/or a CI lcov-threshold step.

### Phase 5 — Optional: stabilize + ratchet (when enabling gating)
- If 95% is not immediately reachable without risky tests, use a **ratchet** once gating is enabled:
  - set `patch` coverage high (e.g., 95%)
  - raise `project` target gradually (e.g., 80 → 90 → 95)

## Files Expected To Change

### Tests (new/extended)
- `test/unit/profiler.test.ts` (new)
- `test/unit/bm25.test.ts` (extend)
- `test/unit/plugin.test.ts` (extend) and/or `test/unit/plugin-tools.test.ts` (new)
- `test/unit/local-client.test.ts` (new)
- `test/unit/remote-client.test.ts` (new)

### Source (minimal refactor for testability)
- `src/plugin.ts` (add `createToolboxPlugin()` + small DI seams)
- (If needed) `src/mcp-client/local.ts`, `src/mcp-client/remote.ts` (add DI seams for transports)

### CI / Coverage config
- `.github/workflows/ci.yml` (optional gating step)
- `codecov.yml` (optional; to enforce 95% via Codecov)

## Verification (Definition of Done)
- `bun test` passes.
- `bun test --coverage --coverage-reporter=lcov` shows **≥ 95% line coverage**.
- Codecov dashboard/badge reflects ≥95% (after CI upload).

## Decisions (Confirmed)
- Metric: **95% line coverage**
- Scope: **all tests** (`test/unit` + `test/integration` + `test/e2e`)
- Current baseline source: **Codecov** (shows ~66%)
- Gating: **none for now** (add later if desired)
- Refactors for testability: **allowed** (minimal DI/export seams)
- Coverage exclusions: **avoid** (prefer mocking/DI instead)
